<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ•µï¸ Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„ØªÙˆÙ†Ø³ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --main-color: #e50914; --bg-color: #0d0d0d; --card-bg: #1f1f1f; --text-color: #ffffff; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* SCREENS */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; box-sizing: border-box; }
        .active { display: flex !important; }
        
        /* LOBBY */
        .logo-area { text-align: center; margin-top: 40px; margin-bottom: 20px; animation: fadeIn 2s; }
        h1 { font-size: 2.5em; margin: 0; color: var(--main-color); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(229, 9, 20, 0.5); }
        
        input, select {
            background: #333; border: 1px solid #444; color: white; padding: 15px; 
            border-radius: 25px; font-size: 1.1em; width: 100%; box-sizing: border-box; text-align: center; margin-bottom: 10px;
        }
        input:focus { border-color: var(--main-color); outline: none; }

        button {
            background: var(--main-color); color: white; border: none; padding: 15px; 
            border-radius: 25px; font-size: 1.2em; font-weight: bold; width: 100%; cursor: pointer;
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4); transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-green { background: #27ae60; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); }

        /* CHAT (Messenger Style) */
        #chat-box { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-bottom: 10px; scroll-behavior: smooth; }
        
        .msg { padding: 12px 16px; border-radius: 18px; font-size: 1em; line-height: 1.5; max-width: 85%; word-wrap: break-word; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .msg.me { align-self: flex-start; background: #0084ff; color: white; border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-end; background: #3e4042; color: white; border-bottom-left-radius: 4px; }
        .msg strong { display: block; font-size: 0.75em; opacity: 0.8; margin-bottom: 4px; }
        
        /* IMAGE CLUES FIX */
        .msg.clue { 
            align-self: center; background: #2c3e50; color: #ecf0f1; border-radius: 12px; 
            width: 95%; text-align: center; border: 1px solid #34495e; animation: popIn 0.5s; 
            padding: 0; overflow: hidden; display: flex; flex-direction: column; margin: 10px 0;
        }
        .clue-img { width: 100%; height: 200px; object-fit: cover; border-bottom: 1px solid #34495e; background: #000; }
        .clue-placeholder { width: 100%; height: 60px; display: flex; align-items: center; justify-content: center; background: #d35400; font-size: 2em; }
        .clue-text { padding: 15px; font-weight: bold; font-size: 1.1em; }

        /* RUMOR FIX */
        .msg.rumor { 
            align-self: center; background: #8e44ad; color: white; border-radius: 12px; 
            width: 90%; text-align: center; font-style: italic; border: 1px solid #9b59b6; 
            padding: 15px; font-size: 1.1em; margin: 10px 0;
        }

        .msg.sys { align-self: center; background: transparent; color: #888; font-size: 0.8em; width: 100%; text-align: center; margin: 10px 0; border: none; box-shadow: none; }

        /* CONTROLS */
        .controls-area { margin-top: auto; padding-top: 10px; border-top: 1px solid #333; background: #1a1a1a; padding-bottom: 10px; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        #msg-input { border-radius: 20px; padding: 12px; flex-grow: 1; margin: 0; background: #2c2c2c; border: none; color: white; }
        #send-btn { width: auto; padding: 10px 20px; margin: 0; border-radius: 50%; background: #0084ff; display: flex; align-items: center; justify-content: center; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-msg" src="https://freesound.org/data/previews/234/234526_4019029-lq.mp3"></audio>
    <audio id="sfx-vote" src="https://freesound.org/data/previews/466/466852_7138092-lq.mp3"></audio>

    <div id="lobby-screen" class="screen active">
        <div class="logo-area">
            <h1>ğŸ•µï¸ Ø§Ù„Ù…Ø­Ù‚Ù‚</h1>
            <p style="color:#aaa;">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø¹Ø¨ Ø§Ù„ØªÙˆÙ†Ø³ÙŠ</p>
        </div>
        <div style="flex-grow: 1; overflow-y: auto;">
            <input type="text" id="username" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ..." maxlength="12">
            <button onclick="joinGame()" id="join-btn">Ø¯Ø®ÙˆÙ„</button>
            <h3 style="margin-top: 20px; color: #666; font-size: 0.9em;">Ø´ÙƒÙˆÙ† Ø¯Ø®Ù„:</h3>
            <ul id="player-list"></ul>
        </div>
        <button onclick="startGame()" class="btn-green">ğŸš€ Ø§Ø¨Ø¯Ø§ Ø§Ù„Ø·Ø±Ø­</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="role-card" style="background: #222; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; text-align: center;">
            <h2 id="role-title" style="margin: 0; color: #fff;">...</h2>
            <p id="case-text" style="color: #aaa; font-size: 0.9em; line-height: 1.6; margin: 10px 0;">...</p>
        </div>
        
        <div id="secret-box" style="display:none; background: #16a085; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; animation: popIn 0.5s;">
            ğŸ¤« <strong>Ù…Ù‡Ù…Ø© Ø³Ø±ÙŠØ©:</strong> <span id="secret-text"></span>
        </div>

        <div id="chat-box"></div>

        <div class="controls-area">
            <div id="vote-ui" style="display:none; margin-bottom: 10px; background: #2980b9; padding: 10px; border-radius: 8px; animation: popIn 0.5s;">
                <h3 style="margin:0 0 5px 0; font-size: 1em; color: white;">ØªØµÙˆÙŠØª Ø·Ø§Ø±Ø¦!</h3>
                <select id="vote-select" style="margin-bottom: 5px;"><option>Ø´ÙƒÙˆÙ† Ø§Ù„Ù‚Ø§ØªÙ„ØŸ</option></select>
                <button onclick="votePlayer()" style="background: #f1c40f; color: black; margin:0;">ØªØ£ÙƒÙŠØ¯</button>
            </div>
            <div class="input-group">
                <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ù…ÙŠØ³Ø§Ø¬...">
                <button id="send-btn" onclick="sendMessage()">â¤</button>
            </div>
        </div>
    </div>

    <div id="win-screen" class="screen" style="justify-content: center; text-align: center;">
        <h1 id="win-title" style="color: #f1c40f; line-height: 1.5;"></h1>
        <button onclick="location.reload()">ğŸ”„ Ø·Ø±Ø­ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        let myName = "";
        const bgMusic = document.getElementById('bg-music');
        bgMusic.volume = 0.3; 

        function playSfx(id) {
            const sfx = document.getElementById(id);
            if(sfx) { sfx.currentTime = 0; sfx.play().catch(e => console.log(e)); }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function speak(text) {
            if('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ar-TN'; window.speechSynthesis.speak(u);
            }
        }

        function joinGame() {
            const name = document.getElementById('username').value.trim();
            if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…!");
            myName = name;
            socket.emit('joinGame', name);
            document.getElementById('join-btn').disabled = true;
            document.getElementById('username').disabled = true;
            bgMusic.play().catch(e => console.log("Click to play audio"));
        }

        function startGame() { socket.emit('startGame'); }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            if(input.value.trim()) { socket.emit('chatMessage', input.value); input.value = ''; input.focus(); }
        }
        
        document.getElementById('msg-input').addEventListener("keypress", function(event) {
            if (event.key === "Enter") { event.preventDefault(); sendMessage(); }
        });

        function votePlayer() {
            const target = document.getElementById('vote-select').value;
            if(target) { socket.emit('votePlayer', target); document.getElementById('vote-ui').style.display = 'none'; }
        }

        socket.on('errorMsg', msg => alert(msg));
        
        socket.on('updatePlayerList', (players) => {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => `<li>ğŸ‘¤ ${p.name} ${p.isDead ? 'ğŸ’€' : ''}</li>`).join('');
            const voteSel = document.getElementById('vote-select');
            voteSel.innerHTML = '<option value="" disabled selected>...</option>';
            players.forEach(p => { if(p.name !== myName) voteSel.innerHTML += `<option value="${p.name}">${p.name}</option>`; });
        });

        socket.on('gameInit', ({ role, title, story }) => {
            showScreen('game-screen');
            const titleEl = document.getElementById('role-title');
            if(role === 'killer') { titleEl.innerText = "ğŸ”ª Ø£Ù†Øª Ø§Ù„Ù‚Ø§ØªÙ„"; titleEl.style.color = "#e50914"; } 
            else { titleEl.innerText = "ğŸ•µï¸ Ø£Ù†Øª Ù…ÙˆØ§Ø·Ù†"; titleEl.style.color = "#2ecc71"; }
            document.getElementById('case-text').innerText = title + "\\n" + story;
            speak("Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©");
        });

        socket.on('secretTask', task => {
            document.getElementById('secret-box').style.display = 'block';
            document.getElementById('secret-text').innerText = task;
        });

        socket.on('newChat', ({ name, msg }) => {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            const isMe = name === myName;
            div.className = `msg ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `<strong>${isMe ? 'Ø£Ù†Ø§' : name}</strong>${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            if(!isMe) playSfx('sfx-msg');
        });

        // --- THE FIX: Better Image Handling ---
        socket.on('newClue', clueObj => {
            const box = document.getElementById('chat-box');
            let imgHTML = '';
            
            // If image exists, show it. If not, show a GENERIC icon placeholder.
            if(clueObj.img) {
                imgHTML = `<img src="${clueObj.img}" class="clue-img" onerror="this.style.display='none'">`;
            } else {
                imgHTML = `<div class="clue-placeholder">ğŸ•µï¸â€â™‚ï¸</div>`; // Fallback Icon
            }
            
            const div = document.createElement('div');
            div.className = 'msg clue';
            div.innerHTML = `${imgHTML}<div class="clue-text">ğŸ’¡ ${clueObj.text}</div>`;
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            playSfx('sfx-msg');
            if(navigator.vibrate) navigator.vibrate(200);
        });

        socket.on('privateRumor', rumor => {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="msg rumor">ğŸ¤« <br>${rumor}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('systemMessage', msg => {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="msg sys">${msg.replace(/\\n/g, '<br>')}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('startVoting', () => {
            document.getElementById('vote-ui').style.display = 'block';
            playSfx('sfx-vote');
            speak("ÙˆÙ‚Øª Ø§Ù„ØªØµÙˆÙŠØª");
        });
        
        socket.on('gameOver', ({ winner, msg }) => {
            showScreen('win-screen');
            document.getElementById('win-title').innerText = msg;
        });

        socket.on('playAudio', text => speak(text));
    </script>
</body>
</html>
