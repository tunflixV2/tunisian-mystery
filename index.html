
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù‚ÙŠÙ‚ ØªÙˆÙ†Ø³ÙŠ (AI) ğŸ‡¹ğŸ‡³</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        body { font-family: 'Cairo', sans-serif; background-color: #0d0d0d; color: #e0e0e0; text-align: center; margin: 0; overflow: hidden; }
        .screen { display: none; padding: 20px; height: 100vh; flex-direction: column; }
        .active { display: flex !important; }

        h1, h2 { color: #c0392b; margin: 10px 0; text-shadow: 0 0 10px rgba(192, 57, 43, 0.5); }
        input, button, select { padding: 12px; margin: 8px 0; border-radius: 6px; border: none; width: 100%; font-size: 16px; box-sizing: border-box; }
        input, select { background: #333; color: white; text-align: center; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: #c0392b; color: white; }
        .btn-vote { background: #f39c12; color: black; }

        #chat-container { flex-grow: 1; overflow-y: auto; background: #1a1a1a; border-radius: 10px; padding: 10px; margin-bottom: 10px; text-align: right; border: 1px solid #333; }
        .message { margin-bottom: 8px; padding: 10px; border-radius: 6px; background: #2c3e50; font-size: 14px; line-height: 1.4; }
        .clue-msg { background: #d35400; color: #fff; border-right: 4px solid #f1c40f; }
        .rumor-msg { background: #8e44ad; color: #fff; border-right: 4px solid #9b59b6; font-style: italic; }
        .sys-msg { background: #222; color: #bbb; text-align: center; font-size: 12px; border: 1px solid #444; }
        .secret-task { background: #27ae60; color: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; font-weight: bold; border: 1px dashed #fff; animation: pulse 2s infinite; }

        .role-card { padding: 15px; border-radius: 10px; margin-bottom: 10px; background: #222; border: 1px solid #444; }
        .killer-role { border-color: #c0392b; color: #e74c3c; }

        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
        .disabled-btn { opacity: 0.5; pointer-events: none; background: #555 !important; }
    </style>
</head>
<body>

    <!-- LOBBY -->
    <div id="lobby-screen" class="screen active">
        <h1>ğŸ‘ï¸ Ø§Ù„Ù…Ø¤Ø§Ù…Ø±Ø© (AI) ğŸ‡¹ğŸ‡³</h1>
        <p>Ù„Ø¹Ø¨Ø© Ù†ÙØ³ÙŠØ© Ø®Ø¨ÙŠØ«Ø©.. Ø§Ù„Ø«Ù‚Ø© Ù…Ù…Ù†ÙˆØ¹Ø©.</p>
        <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ..." />
        <button class="btn-primary" onclick="joinGame()">Ø¯Ø®ÙˆÙ„</button>

        <div style="flex-grow: 1; overflow-y: auto; width: 100%; margin-top: 20px;">
            <h3>Ø§Ù„Ø¶Ø­Ø§ÙŠØ§ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†:</h3>
            <ul id="player-list" style="list-style: none; padding: 0;"></ul>
        </div>

        <button class="btn-primary" style="background: #27ae60; margin-top: auto;" onclick="startGame()">ğŸš€ Ø§Ø¨Ø¯Ø§ Ø§Ù„Ø±Ø¹Ø¨ (2+)</button>
    </div>

    <!-- GAMEPLAY -->
    <div id="game-screen" class="screen">
        <div id="role-display" class="role-card">
            <h2 id="role-title" style="margin:0;">...</h2>
            <p id="case-story" style="color: #bbb; font-size: 0.85em; margin: 5px 0;">...</p>
        </div>

        <div id="secret-area" style="display:none;" class="secret-task">
            ğŸ¤« Ù…Ù‡Ù…Ø© Ø³Ø±ÙŠØ©: <span id="secret-text"></span>
        </div>

        <div id="chat-container"></div>

        <div style="display: flex;">
            <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨..." style="width: 75%; margin-left: 5px;" />
            <button onclick="sendMessage()" class="btn-primary" style="width: 25%;">Ø§Ø¨Ø¹Ø«</button>
        </div>

        <div id="killer-controls" style="display:none; margin-top: 10px; border-top: 1px solid #444; padding-top: 5px;">
            <select id="target-select"><option value="" disabled selected>Ø§Ù„Ø¶Ø­ÙŠØ©...</option></select>
            <button id="kill-btn" class="btn-primary" onclick="killPlayer()">ğŸ”ª ØªØµÙÙŠØ©</button>
            <p id="cooldown-msg" style="color: #e74c3c; font-size: 12px; display: none;">â³ Cooldown...</p>
        </div>

        <div id="vote-controls" style="display:none; margin-top: 10px; background: #2980b9; padding: 10px; border-radius: 8px;">
            <select id="vote-select"><option value="" disabled selected>Ø§Ù„Ù…Ø´ØªØ¨Ù‡ ÙÙŠÙ‡...</option></select>
            <button class="btn-vote" onclick="votePlayer()">Ø¥Ø¹Ø¯Ø§Ù…</button>
        </div>
    </div>

    <!-- SCREENS -->
    <div id="dead-screen" class="screen" style="justify-content: center; background: #300;">
        <h1>ğŸ’€ Game Over</h1>
        <p>Ù„Ù‚Ø¯ ØªÙ… Ø¥Ù‚ØµØ§Ø¤Ùƒ.</p>
    </div>
    <div id="win-screen" class="screen" style="justify-content: center;">
        <h1 id="win-msg" style="color: #f1c40f;"></h1>
        <button class="btn-primary" onclick="location.reload()">ğŸ”„ Replay</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRole = '';

        // --- TTS Helper (Audio) ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-TN'; // Try Tunisian/Arabic
                utterance.rate = 0.9;
                utterance.pitch = 0.8; // Deep voice
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- Core ---
        function joinGame() {
            const name = document.getElementById('username').value;
            if(name) { socket.emit('joinGame', name); document.getElementById('username').disabled = true; }
        }
        function startGame() { socket.emit('startGame'); }
        function sendMessage() {
            const val = document.getElementById('msg-input').value;
            if(val) { socket.emit('chatMessage', val); document.getElementById('msg-input').value = ''; }
        }
        function killPlayer() {
            const target = document.getElementById('target-select').value;
            if(target && confirm("Kill " + target + "?")) socket.emit('killPlayer', target);
        }
        function votePlayer() {
            const target = document.getElementById('vote-select').value;
            if(target) { socket.emit('votePlayer', target); document.getElementById('vote-controls').style.display = 'none'; }
        }

        function updateDropdowns(players) {
            const user = document.getElementById('username').value;
            const killSel = document.getElementById('target-select');
            const voteSel = document.getElementById('vote-select');
            killSel.innerHTML = voteSel.innerHTML = '<option value="" disabled selected>...</option>';

            players.forEach(p => {
                if(!p.isDead && p.name !== user) {
                    const opt = `<option value="${p.name}">${p.name}</option>`;
                    killSel.innerHTML += opt;
                    voteSel.innerHTML += opt;
                }
            });
        }

        // --- Events ---
        socket.on('updatePlayerList', (players) => {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => `<li>ğŸ‘¤ ${p.name} ${p.isDead ? 'ğŸ’€' : ''}</li>`).join('');
            updateDropdowns(players);
        });

        socket.on('gameInit', (data) => {
            document.getElementById('lobby-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            myRole = data.role;

            const title = document.getElementById('role-title');
            const card = document.getElementById('role-display');

            if (myRole === 'killer') {
                title.innerText = "ğŸ”ª Ø£Ù†Øª Ø§Ù„Ù‚Ø§ØªÙ„";
                card.classList.add('killer-role');
                document.getElementById('killer-controls').style.display = 'block';
            } else {
                title.innerText = "ğŸ•µï¸ Ø£Ù†Øª Ø¨Ø±ÙŠØ¡";
                document.getElementById('killer-controls').style.display = 'none';
            }
            document.getElementById('case-story').innerText = data.caseTitle + "\n" + data.story;
            speak("Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©. " + data.caseTitle);
        });

        socket.on('secretTask', (task) => {
            const area = document.getElementById('secret-area');
            const text = document.getElementById('secret-text');
            area.style.display = 'block';
            text.innerText = task;
            speak("Ø¹Ù†Ø¯Ùƒ Ù…Ù‡Ù…Ø© Ø³Ø±ÙŠØ©.");
        });

        socket.on('newChat', (data) => {
            const box = document.getElementById('chat-container');
            box.innerHTML += `<div class="message"><strong>${data.name}:</strong> ${data.msg}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('newClue', (clue) => {
            const box = document.getElementById('chat-container');
            box.innerHTML += `<div class="message clue-msg">ğŸ’¡ <strong>Ø¯Ù„ÙŠÙ„:</strong> ${clue}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('privateRumor', (rumor) => {
            const box = document.getElementById('chat-container');
            box.innerHTML += `<div class="message rumor-msg">ğŸ¤« <strong>Ø¥Ø´Ø§Ø¹Ø© (Ù„ÙŠÙƒ ÙˆØ­Ø¯Ùƒ):</strong> ${rumor}</div>`;
            box.scrollTop = box.scrollHeight;
            if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
            speak("ÙˆØµÙ„ØªÙƒ Ø¥Ø´Ø§Ø¹Ø© Ø³Ø±ÙŠØ©.");
        });

        socket.on('playAudio', (text) => {
            speak(text);
        });

        socket.on('systemMessage', (msg) => {
            const box = document.getElementById('chat-container');
            box.innerHTML += `<div class="message sys-msg">${msg.replace(/\n/g, '<br>')}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('startVoting', () => {
            document.getElementById('vote-controls').style.display = 'block';
            speak("ÙˆÙ‚Øª Ø§Ù„ØªØµÙˆÙŠØª.");
        });

        socket.on('cooldownStart', (sec) => {
            const btn = document.getElementById('kill-btn');
            btn.classList.add('disabled-btn');
            btn.innerText = `Wait ${sec}s`;
            document.getElementById('cooldown-msg').style.display = 'block';
        });

        socket.on('cooldownEnd', () => {
            const btn = document.getElementById('kill-btn');
            btn.classList.remove('disabled-btn');
            btn.innerText = "ğŸ”ª ØªØµÙÙŠØ©";
            document.getElementById('cooldown-msg').style.display = 'none';
        });

        socket.on('playerDied', (data) => {
            const box = document.getElementById('chat-container');
            box.innerHTML += `<div class="message" style="background: darkred; color: white;">ğŸ’€ ${data.name} Ù…Ø§Øª!</div>`;
        });

        socket.on('youDied', () => {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('dead-screen').classList.add('active');
        });

        socket.on('gameOver', (data) => {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('dead-screen').classList.remove('active');
            document.getElementById('win-screen').classList.add('active');
            document.getElementById('win-msg').innerText = data.msg;
        });
    </script>
</body>
</html>
