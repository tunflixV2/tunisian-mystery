
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù‚ÙŠÙ‚ ØªÙˆÙ†Ø³ÙŠ ğŸ‡¹ğŸ‡³</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        body { font-family: 'Cairo', sans-serif; background-color: #121212; color: #eee; text-align: center; margin: 0; padding: 0; overflow: hidden; }
        .screen { display: none; padding: 20px; height: 100vh; box-sizing: border-box; flex-direction: column; }
        .active { display: flex !important; }

        h1, h2 { color: #e74c3c; margin: 10px 0; }
        input, select { padding: 15px; margin: 10px 0; border-radius: 8px; border: none; width: 90%; font-size: 16px; text-align: center; background: #333; color: white; }
        button { padding: 15px; margin: 10px 0; border-radius: 8px; cursor: pointer; border: none; font-size: 18px; font-weight: bold; width: 90%; transition: 0.2s; }
        .btn-primary { background-color: #c0392b; color: white; }
        .btn-vote { background-color: #f39c12; color: black; }

        #chat-container { flex-grow: 1; overflow-y: auto; background: #1e1e1e; border-radius: 10px; padding: 10px; margin-bottom: 10px; text-align: right; border: 1px solid #333; }
        .message { margin-bottom: 8px; padding: 8px; border-radius: 5px; background: #2c3e50; font-size: 14px; }
        .clue-msg { background: #d35400; color: #fff; border-left: 4px solid #f1c40f; }
        .sys-msg { background: #8e44ad; color: white; text-align: center; font-size: 12px; }

        .role-card { padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #555; background: #222; }
        .killer-role { border-color: #c0392b; color: #e74c3c; }
        .citizen-role { border-color: #27ae60; color: #2ecc71; }

        /* Cooldown Overlay for Button */
        .disabled-btn { opacity: 0.5; pointer-events: none; background: #555 !important; }

    </style>
</head>
<body>

    <!-- 1. LOBBY -->
    <div id="lobby-screen" class="screen active">
        <h1>ğŸ•µï¸ Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„ØªÙˆÙ†Ø³ÙŠ ğŸ‡¹ğŸ‡³</h1>
        <p>Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙŠÙƒ ÙÙŠ Ø£Ø®Ø·Ø± Ù„Ø¹Ø¨Ø© ØªØ­Ù‚ÙŠÙ‚..</p>
        <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ (Ø¨Ø§Ø´ ÙŠØ¹Ø±ÙÙˆÙƒ ØµØ­Ø§Ø¨Ùƒ)" />
        <button class="btn-primary" onclick="joinGame()">Ø¯Ø®ÙˆÙ„ Ù„Ù„ØºØ±ÙØ©</button>

        <div style="flex-grow: 1; overflow-y: auto; width: 100%;">
            <h3>Ø´ÙƒÙˆÙ† Ø¯Ø®Ù„:</h3>
            <ul id="player-list" style="list-style: none; padding: 0;"></ul>
        </div>

        <div id="admin-controls" style="margin-top: auto; width: 100%;">
            <label>Ø§Ø®ØªØ§Ø± Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ:</label>
            <select id="case-select">
                <option value="1">Ø¬Ø±ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù€ Colocation ğŸ </option>
                <option value="2">Ø³Ø±Ù‚Ø© Ø§Ù„Ù‚Ù‡ÙˆØ© â˜•</option>
            </select>
            <button class="btn-primary" style="background: #27ae60;" onclick="startGame()">ğŸš€ Ø§Ø¨Ø¯Ø§ Ø§Ù„Ø·Ø±Ø­ (2+)</button>
        </div>
    </div>

    <!-- 2. GAMEPLAY -->
    <div id="game-screen" class="screen">
        <!-- Role Header -->
        <div id="role-display" class="role-card">
            <h2 id="role-title" style="margin:0;">...</h2>
            <p id="case-story" style="color: #bbb; font-size: 0.9em; margin: 5px 0;">...</p>
        </div>

        <!-- Chat Area -->
        <div id="chat-container"></div>

        <!-- Input Area -->
        <div style="display: flex; width: 100%;">
            <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø­Ø§Ø¬Ø©..." style="width: 70%; margin: 5px;" />
            <button onclick="sendMessage()" class="btn-primary" style="width: 25%; margin: 5px; font-size: 14px;">Ø§Ø¨Ø¹Ø«</button>
        </div>

        <!-- KILLER Actions -->
        <div id="killer-controls" style="display:none; width: 100%; margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">
            <select id="target-select" style="width: 100%; background: #444;">
                <option value="" disabled selected>Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¶Ø­ÙŠØ©...</option>
            </select>
            <button id="kill-btn" class="btn-primary" onclick="killPlayer()">ğŸ”ª Ø§Ù‚ØªÙ„ ØªÙˆ!</button>
            <p id="cooldown-msg" style="color: #e74c3c; font-size: 12px; display: none;">â³ Ø§Ù„Ø³Ù„Ø§Ø­ Ø³Ø®ÙˆÙ†.. Ø§Ø³ØªÙ†Ù‰ Ø´ÙˆÙŠ</p>
        </div>

        <!-- VOTING Actions -->
        <div id="vote-controls" style="display:none; width: 100%; margin-top: 10px; background: #2980b9; padding: 10px; border-radius: 8px;">
            <h3 style="color:white; margin:0;">ğŸ—³ï¸ Ø´ÙƒÙˆÙ† Ø§Ù„Ù‚Ø§ØªÙ„ØŸ</h3>
            <select id="vote-select" style="width: 100%; background: #fff; color: #000;">
                 <option value="" disabled selected>ØµÙˆÙ‘Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´ØªØ¨Ù‡ ÙÙŠÙ‡...</option>
            </select>
            <button class="btn-vote" onclick="votePlayer()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙˆÙŠØª</button>
        </div>
    </div>

    <!-- 3. DEAD SCREEN -->
    <div id="dead-screen" class="screen" style="justify-content: center; background: #4a0000;">
        <h1 style="font-size: 4em;">ğŸ’€ Ù…ØªÙ‘!</h1>
        <p>Ø§Ù„Ù„Ù‡ ÙŠØ±Ø­Ù…Ùƒ.. ÙƒÙ…Ù„ ØªÙØ±Ø¬ ÙÙŠÙ‡Ù… Ø³Ø§ÙƒØª.</p>
    </div>

    <!-- 4. WIN SCREEN -->
    <div id="win-screen" class="screen" style="justify-content: center; background: #1a1a1a;">
        <h1 id="win-msg" style="color: #f1c40f;"></h1>
        <button class="btn-primary" onclick="location.reload()">ğŸ”„ Ø·Ø±Ø­ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRole = '';
        let playersList = [];

        // --- Core Functions ---

        function joinGame() {
            const name = document.getElementById('username').value;
            if(name) {
                socket.emit('joinGame', name);
                document.getElementById('username').disabled = true;
                // document.querySelector('button[onclick="joinGame()"]').style.display = 'none';
            } else {
                alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙŠÙ‡Ø¯ÙŠÙƒ!");
            }
        }

        function startGame() {
            const caseId = document.getElementById('case-select').value;
            socket.emit('startGame', caseId);
        }

        function sendMessage() {
            const msgInput = document.getElementById('msg-input');
            const msg = msgInput.value;
            if(msg) {
                socket.emit('chatMessage', msg);
                msgInput.value = '';
            }
        }

        function killPlayer() {
            const target = document.getElementById('target-select').value;
            if(!target) return alert("Ø§Ø®ØªØ§Ø± Ø´ÙƒÙˆÙ† Ø¨Ø§Ø´ ØªÙ‚ØªÙ„ Ø§Ù„Ø³Ø§Ø¹Ø©!");

            if(confirm("Ù…ØªØ£ÙƒØ¯ ØªØ­Ø¨ ØªÙ‚ØªÙ„ " + target + "ØŸ")) {
                socket.emit('killPlayer', target);
            }
        }

        function votePlayer() {
            const target = document.getElementById('vote-select').value;
            if(!target) return alert("Ø§Ø®ØªØ§Ø± Ø´ÙƒÙˆÙ† Ø¨Ø§Ø´ ØªØµÙˆØª Ø¹Ù„ÙŠÙ‡!");

            socket.emit('votePlayer', target);
            document.getElementById('vote-controls').style.display = 'none'; // Hide after vote
        }

        function updateDropdowns(players) {
            // Update Killer & Vote Dropdowns
            const killSelect = document.getElementById('target-select');
            const voteSelect = document.getElementById('vote-select');

            // Clear current
            killSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¶Ø­ÙŠØ©...</option>';
            voteSelect.innerHTML = '<option value="" disabled selected>ØµÙˆÙ‘Øª Ø¹Ù„Ù‰...</option>';

            players.forEach(p => {
                if(!p.isDead && p.name !== document.getElementById('username').value) {
                    // Add to dropdowns
                    const opt1 = document.createElement('option');
                    opt1.value = p.name;
                    opt1.innerText = p.name;
                    killSelect.appendChild(opt1);

                    const opt2 = document.createElement('option');
                    opt2.value = p.name;
                    opt2.innerText = p.name;
                    voteSelect.appendChild(opt2);
                }
            });
        }

        // --- Socket Events ---

        socket.on('updatePlayerList', (players) => {
            playersList = players;
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => 
                `<li style="padding: 10px; border-bottom: 1px solid #444; display:flex; justify-content:space-between;">
                    <span>ğŸ‘¤ ${p.name}</span>
                    <span style="font-size:0.8em; color:#777;">${p.isDead ? 'ğŸ’€ Ù…ÙŠØª' : 'âœ… Ø­ÙŠ'}</span>
                </li>`
            ).join('');

            // Update dropdowns dynamically
            updateDropdowns(players);
        });

        socket.on('errorMsg', (msg) => alert(msg));

        socket.on('gameInit', (data) => {
            document.getElementById('lobby-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');

            myRole = data.role;
            const roleTitle = document.getElementById('role-title');
            const roleCard = document.getElementById('role-display');

            if (myRole === 'killer') {
                roleTitle.innerText = "ğŸ”ª Ø£Ù†Øª Ø§Ù„Ù‚Ø§ØªÙ„!";
                roleCard.classList.add('killer-role');
                document.getElementById('killer-controls').style.display = 'block';
            } else {
                roleTitle.innerText = "ğŸ•µï¸ Ø£Ù†Øª Ù…ÙˆØ§Ø·Ù† Ø¨Ø±ÙŠØ¡";
                roleCard.classList.add('citizen-role');
                document.getElementById('killer-controls').style.display = 'none';
            }
            document.getElementById('case-story').innerText = data.caseTitle + "\n" + data.story;
        });

        socket.on('newChat', (data) => {
            const box = document.getElementById('chat-container');
            box.innerHTML += `<div class="message"><strong>${data.name}:</strong> ${data.msg}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('newClue', (clue) => {
            const box = document.getElementById('chat-container');
            box.innerHTML += `<div class="message clue-msg">ğŸ’¡ <strong>Ø¯Ù„ÙŠÙ„:</strong> ${clue}</div>`;
            box.scrollTop = box.scrollHeight;
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });

        socket.on('systemMessage', (msg) => {
            const box = document.getElementById('chat-container');
            const formattedMsg = msg.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            box.innerHTML += `<div class="message sys-msg">${formattedMsg}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('startVoting', () => {
            document.getElementById('vote-controls').style.display = 'block';
            // Vibrate to alert
            if(navigator.vibrate) navigator.vibrate(500);
        });

        socket.on('cooldownStart', (seconds) => {
            const btn = document.getElementById('kill-btn');
            const msg = document.getElementById('cooldown-msg');
            btn.classList.add('disabled-btn');
            btn.innerText = `Ø§Ø³ØªÙ†Ù‰ (${seconds}s)`;
            msg.style.display = 'block';
        });

        socket.on('cooldownEnd', () => {
            const btn = document.getElementById('kill-btn');
            const msg = document.getElementById('cooldown-msg');
            btn.classList.remove('disabled-btn');
            btn.innerText = "ğŸ”ª Ø§Ù‚ØªÙ„ ØªÙˆ!";
            msg.style.display = 'none';
        });

        socket.on('playerDied', (data) => {
            const box = document.getElementById('chat-container');
            box.innerHTML += `<div class="message" style="background: #c0392b; color: white;">â˜ ï¸ <strong>${data.name}</strong> Ù…Ø§Øª!</div>`;
        });

        socket.on('youDied', () => {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('dead-screen').classList.add('active');
        });

        socket.on('gameOver', (data) => {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('dead-screen').classList.remove('active');
            document.getElementById('win-screen').classList.add('active');
            document.getElementById('win-msg').innerText = data.msg;
        });
    </script>
</body>
</html>
